<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plex Info - Library Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #3498db;
        }

        .sidebar .server-info {
            background: #34495e;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .sidebar .server-info p {
            margin: 5px 0;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            color: #ecf0f1;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .sidebar nav ul li a:hover {
            background: #34495e;
        }

        .sidebar nav ul li a.active {
            background: #3498db;
        }

        .refresh-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Main content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 40px;
            max-width: 1200px;
        }

        .section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        /* Error/Warning messages */
        .error-box {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .warning-box {
            background: #f39c12;
            color: white;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .info-box {
            background: #ecf0f1;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            border-radius: 4px;
        }

        code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 4px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Library filter */
        .filter-bar {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .filter-bar label {
            margin-right: 20px;
        }

        .filter-bar select, .filter-bar input[type="text"] {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            margin-left: 5px;
            font-size: 14px;
        }

        /* Item cards */
        .item-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .item-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .item-details div {
            padding: 5px 0;
        }

        .item-details strong {
            color: #555;
        }

        .subtitle-streams {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .subtitle-streams ul {
            list-style: none;
            padding-left: 10px;
        }

        .subtitle-streams li {
            padding: 3px 0;
            font-size: 0.85rem;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 999;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .menu-toggle {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: 80px 20px 20px;
            }

            .item-details {
                grid-template-columns: 1fr;
            }

            .filter-bar label {
                display: block;
                margin-bottom: 10px;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" onclick="toggleSidebar()">☰ Menu</button>

    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <h1>Plex Info</h1>

            <div class="server-info" id="server-info">
                <p><strong>Updated:</strong> <span id="data-timestamp">-</span></p>
            </div>

            <nav>
                <ul id="library-nav">
                    <li><a onclick="showSection('overview')">Overview</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Loading state -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading Plex data...</p>
            </div>

            <!-- Error state (no JSON file) -->
            <div class="section" id="no-data-error" style="display: none;">
                <h2>No Data Found</h2>
                <div class="warning-box">
                    <p><strong>⚠️ Data file not found</strong></p>
                    <p>Please generate the data file first by running:</p>
                </div>
                <div class="info-box">
                    <code>python plex_info.py --export-json plex_data.json</code>
                </div>
                <p style="margin-top: 20px;">This will scan your Plex libraries and create <code>plex_data.json</code> with all your media information.</p>
                <p style="margin-top: 10px;">After running the command, refresh this page to view your data.</p>
            </div>

            <!-- Content sections (populated by JavaScript) -->
            <div id="content-sections"></div>
        </main>
    </div>

    <script>
        let plexData = null;

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadData);

        // Toggle sidebar on mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        // Show section
        function showSection(id) {
            const section = document.getElementById(id);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Load data from JSON file
        async function loadData() {
            try {
                const response = await fetch('plex_data.json');

                if (!response.ok) {
                    throw new Error('Data file not found');
                }

                plexData = await response.json();

                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-data-error').style.display = 'none';

                // Populate interface
                populateServerInfo();
                populateNavigation();
                populateContent();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-data-error').style.display = 'block';
            }
        }

        // Populate server info
        function populateServerInfo() {
            document.getElementById('data-timestamp').textContent = plexData.timestamp || '-';
        }

        // Populate navigation
        function populateNavigation() {
            const nav = document.getElementById('library-nav');

            // Add overview
            nav.innerHTML = '<li><a onclick="showSection(\'overview\')">Overview</a></li>';

            // Add each library
            plexData.libraries.forEach((library, idx) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.textContent = library.name;
                a.onclick = () => showSection(`library-${idx}`);
                li.appendChild(a);
                nav.appendChild(li);
            });
        }

        // Populate content
        function populateContent() {
            const content = document.getElementById('content-sections');

            // Overview section
            const overview = createOverviewSection();
            content.appendChild(overview);

            // Library sections
            plexData.libraries.forEach((library, idx) => {
                const section = createLibrarySection(library, idx);
                content.appendChild(section);
            });
        }

        // Create overview section
        function createOverviewSection() {
            const section = document.createElement('section');
            section.className = 'section';
            section.id = 'overview';

            let totalItems = 0;
            let totalWithSubs = 0;
            let totalWithoutSubs = 0;

            plexData.libraries.forEach(lib => {
                totalItems += lib.items.length;
                lib.items.forEach(item => {
                    if (item.has_subtitles) {
                        totalWithSubs++;
                    } else {
                        totalWithoutSubs++;
                    }
                });
            });

            section.innerHTML = `
                <h2>Overview</h2>
                <p>Plex library data as of <strong>${plexData.timestamp}</strong></p>

                <h3>Plex Server</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 style="font-size: 1.2rem;">${plexData.server.name || 'Unknown'}</h3>
                        <p>Server Name</p>
                    </div>
                    <div class="stat-card">
                        <h3 style="font-size: 1.2rem;">${plexData.server.version || 'Unknown'}</h3>
                        <p>Plex Version</p>
                    </div>
                    <div class="stat-card">
                        <h3 style="font-size: 1.2rem;">${plexData.server.platform || 'Unknown'}</h3>
                        <p>Platform</p>
                    </div>
                    <div class="stat-card">
                        <h3 style="font-size: 1.2rem;">${plexData.server.platform_version || 'Unknown'}</h3>
                        <p>OS Version</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Library Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${plexData.libraries.length}</h3>
                        <p>Libraries</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalItems}</h3>
                        <p>Total Items</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalWithSubs}</h3>
                        <p>With Subtitles</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalWithoutSubs}</h3>
                        <p>Without Subtitles</p>
                    </div>
                </div>
            `;

            return section;
        }

        // Create library section
        function createLibrarySection(library, idx) {
            const section = document.createElement('section');
            section.className = 'section';
            section.id = `library-${idx}`;

            const withSubs = library.items.filter(i => i.has_subtitles).length;
            const withoutSubs = library.items.length - withSubs;

            section.innerHTML = `
                <h2>${library.name} <span class="badge badge-info">${library.type}</span></h2>
                <p>Total items: <strong>${library.items.length}</strong> |
                   With subtitles: <strong>${withSubs}</strong> |
                   Without subtitles: <strong>${withoutSubs}</strong></p>

                <div class="filter-bar">
                    <label>
                        <input type="checkbox" id="filter-missing-${idx}" onchange="filterLibrary(${idx})">
                        Show only items missing subtitles
                    </label>
                    <label>
                        <input type="text" id="search-${idx}" placeholder="Search..." oninput="filterLibrary(${idx})">
                    </label>
                </div>

                <div id="items-${idx}"></div>
            `;

            // Add items
            setTimeout(() => renderLibraryItems(library, idx), 0);

            return section;
        }

        // Render library items
        function renderLibraryItems(library, idx) {
            const container = document.getElementById(`items-${idx}`);
            const showMissingOnly = document.getElementById(`filter-missing-${idx}`).checked;
            const searchTerm = document.getElementById(`search-${idx}`).value.toLowerCase();

            container.innerHTML = '';

            let items = library.items;

            // Filter
            if (showMissingOnly) {
                items = items.filter(item => !item.has_subtitles);
            }

            if (searchTerm) {
                items = items.filter(item => item.title.toLowerCase().includes(searchTerm));
            }

            if (items.length === 0) {
                container.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No items match the current filter</p>';
                return;
            }

            items.forEach(item => {
                const card = createItemCard(item);
                container.appendChild(card);
            });
        }

        // Create item card
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';

            const watchedBadge = item.watched
                ? '<span class="badge badge-success">✓ Watched</span>'
                : '<span class="badge badge-danger">✗ Unwatched</span>';

            const subsBadge = item.has_subtitles
                ? '<span class="badge badge-success">Subtitles</span>'
                : '<span class="badge badge-danger">No Subtitles</span>';

            let subsInfo = '';
            if (item.has_subtitles && item.subtitle_streams && item.subtitle_streams.length > 0) {
                subsInfo = '<div class="subtitle-streams"><strong>Subtitle Streams:</strong><ul>';
                item.subtitle_streams.forEach(stream => {
                    const forced = stream.forced ? ' [FORCED]' : '';
                    const external = stream.external ? ' [EXTERNAL]' : ' [EMBEDDED]';
                    subsInfo += `<li>• ${stream.language} (${stream.language_code.toUpperCase()}) - ${stream.format}${forced}${external}</li>`;
                });
                subsInfo += '</ul></div>';
            }

            card.innerHTML = `
                <h3>${item.title} ${watchedBadge} ${subsBadge}</h3>
                <div class="item-details">
                    <div><strong>Rating Key:</strong> ${item.rating_key}</div>
                    <div><strong>File Size:</strong> ${item.filesize}</div>
                    <div><strong>Quality:</strong> ${item.resolution}</div>
                    <div><strong>Video:</strong> ${item.video_codec}</div>
                    <div><strong>Audio:</strong> ${item.audio_codec}</div>
                    <div><strong>Views:</strong> ${item.view_count}</div>
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem;">
                    <strong>File Path:</strong> <code style="background: #ecf0f1; color: #333; padding: 2px 6px;">${item.filepath}</code>
                </div>
                <div style="margin-top: 5px; font-size: 0.85rem;">
                    <strong>Plex URL:</strong> <a href="${item.url}" target="_blank" style="color: #3498db;">${item.url}</a>
                </div>
                ${subsInfo}
            `;

            return card;
        }

        // Filter library items
        function filterLibrary(idx) {
            const library = plexData.libraries[idx];
            renderLibraryItems(library, idx);
        }
    </script>
</body>
</html>